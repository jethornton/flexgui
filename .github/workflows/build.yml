name: Build and Release .deb packages

on:
  push:
    tags:
      # Matches tags like 1.0.0, 20.10.5, etc. (No leading 'v')
      - '[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

jobs:
  build_arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential debhelper devscripts

      - name: Sync version with Git Tag
        run: |
          # Extract version (directly from tag, no 'v' to strip)
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Setting package version to $VERSION"
          
          export DEBEMAIL="actions@github.com"
          export DEBFULLNAME="GitHub Actions"
          
          # Update changelog
          dch -v "$VERSION" "Release $VERSION"
          dch -r ""

      - name: Build
        run: |
          debuild -us -uc

      - name: Prepare artifacts
        run: |
          mkdir -p deb-artifacts
          mv ../*.deb deb-artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flexgui-arm64
          path: deb-artifacts/*.deb
          if-no-files-found: error

  build_amd64:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential debhelper devscripts

      - name: Sync version with Git Tag
        run: |
          # Extract version (directly from tag, no 'v' to strip)
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Setting package version to $VERSION"
          export DEBEMAIL="actions@github.com"
          export DEBFULLNAME="GitHub Actions"
          dch -v "$VERSION" "Release $VERSION"
          dch -r ""

      - name: Build
        run: |
          debuild -us -uc

      - name: Prepare artifacts
        run: |
          mkdir -p deb-artifacts
          mv ../*.deb deb-artifacts/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: flexgui-amd64
          path: deb-artifacts/*.deb
          if-no-files-found: error

  create_release:
    needs: [build_arm64, build_amd64]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: flexgui-*
          merge-multiple: true

      # Don't create named versions of source archives, just use the default ones generated by github.
      # - name: Create Source Archives
      #   run: |
      #     # Extract version directly (1.3.2)
      #     VERSION=${GITHUB_REF#refs/tags/}
      #     echo "Creating source archives for version $VERSION..."
          
      #     # Create source.tar.gz and source.zip with the version in the filename
      #     git archive --format=tar.gz --prefix=flexgui-${VERSION}/ --output=flexgui_${VERSION}_source.tar.gz HEAD
      #     git archive --format=zip --prefix=flexgui-${VERSION}/ --output=flexgui_${VERSION}_source.zip HEAD

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            artifacts/*.deb
            # *.tar.gz
            # *.zip
          generate_release_notes: true
